<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>TUSAÅž - Technological Radar</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            height: 100%;
            font-family: "Segoe UI", sans-serif;
            background-color: #f5f5f5;
        }

        body {
            display: flex;
        }

        nav {
            width: 220px;
            background-color: #003366;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }

        nav img {
            width: 100%;
            margin-bottom: 2rem;
        }

        .user-info-box {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 2rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .user-info-box p {
            margin: 4px 0;
            color: #ffffff;
        }

        .user-info-box p strong {
            color: #ffffcc;
        }

        nav button {
            background: none;
            border: none;
            color: white;
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            border-radius: 4px;
            transition: background 0.3s;
        }

        nav button:hover {
            background-color: #004080;
        }

        .main-wrapper {
            margin-left: 220px;
            width: calc(100% - 220px);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background-color: #003366;
            color: white;
            padding: 1rem;
            text-align: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        #chart {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(0, 51, 102, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
            pointer-events: none;
            font-size: 0.9rem;
            max-width: 300px;
            z-index: 10;
            display: none;
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<nav>
    <img src="/images/800px-Tai_logo.png" alt="TUSAÅž Logo" />

    <div class="user-info-box">
        <p>ðŸ‘¤ <strong th:text="${userName}">Ad Soyad</strong></p>
        <p>ðŸ”‘ <strong th:text="${userRole}">Rol</strong></p>
        <p> <strong th:text="${userExpertise}">Expertise</strong></p>

    </div>
    <p><strong>Mega Trends</strong></p>
    <button onclick="alert('Defence')">Defence</button>
    <button onclick="alert('Aviation')">Aviation</button>
</nav>


<!-- Main content -->
<div class="main-wrapper">
    <header>
        <h1>Technological Radar</h1>
    </header>
    <div id="chart"></div>
</div>

<!-- Tooltip -->
<div class="tooltip" id="tooltip"></div>

<script>
    let svg, container;
    const chartElement = document.getElementById("chart");
    const tooltip = d3.select("#tooltip");

    async function fetchChartData() {
        const res = await fetch("/api/drivers/average-impacts");
        return res.ok ? res.json() : [];
    }

    function setupSVG(width, height) {
        d3.select("#chart").select("svg").remove();

        svg = d3.select("#chart")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%");
        const zoomGroup = svg.append("g");

        svg.call(
            d3.zoom()
                .scaleExtent([0.5, 4])
                .on("zoom", (event) => {
                    zoomGroup.attr("transform", event.transform);
                })
        );

        container = zoomGroup.append("g")
            .attr("transform", `translate(${width / 2}, ${height / 2})`);
    }

    async function renderRadar(data) {
        const width = chartElement.clientWidth;
        const height = chartElement.clientHeight;
        const radius = Math.min(width, height) / 4;

        setupSVG(width, height);
        container.selectAll("*").remove();

        const angleSlice = (2 * Math.PI) / data.length;

        const colorScale = d3.scaleThreshold()
            .domain([1, 2, 3, 4])
            .range(["#d73027", "#fc8d59", "#fee08b", "#91cf60", "#1a9850"]);

        for (let i = 1; i <= 5; i++) {
            container.append("circle")
                .attr("r", radius * i / 5)
                .style("fill", "none")
                .style("stroke", "#ccc");
        }

        data.forEach((d, i) => {
            const angle = i * angleSlice - Math.PI / 2;
            const x = radius * Math.cos(angle);
            const y = radius * Math.sin(angle);
            container.append("line")
                .attr("x1", 0).attr("y1", 0)
                .attr("x2", x).attr("y2", y)
                .style("stroke", "#aaa");
        });

        container.selectAll("circle.trend-point")
            .data(data)
            .enter()
            .append("circle")
            .attr("class", "trend-point")
            .attr("r", 6)
            .attr("fill", d => colorScale(d.averageImpact))
            .attr("cx", (d, i) => radius * (d.averageImpact / 5) * Math.cos(i * angleSlice - Math.PI / 2))
            .attr("cy", (d, i) => radius * (d.averageImpact / 5) * Math.sin(i * angleSlice - Math.PI / 2))
            .style("cursor", "pointer")
            .on("mouseover", (event, d) => {
                tooltip
                    .style("display", "block")
                    .html(`<strong>${d.trend}</strong><br>${d.definition}`);
            })
            .on("mousemove", (event) => {
                tooltip
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY + 10) + "px");
            })
            .on("mouseout", () => {
                tooltip.style("display", "none");
            })
            .on("click", (event, d) => {
                window.location.href = `/drivers.html?trend=${encodeURIComponent(d.trend)}`;
            });

        container.selectAll("text.label")
            .data(data)
            .enter()
            .append("text")
            .attr("class", "label")
            .attr("dy", "0.35em")
            .attr("transform", (d, i) => {
                const angle = angleSlice * i - Math.PI / 2;
                const x = Math.cos(angle) * (radius + 10);
                const y = Math.sin(angle) * (radius + 10);
                const angleDeg = angle * 180 / Math.PI;
                const rotate = angleDeg > 90 || angleDeg < -90 ? angleDeg + 180 : angleDeg;
                return `translate(${x},${y}) rotate(${rotate})`;
            })
            .attr("text-anchor", (d, i) => {
                const angle = angleSlice * i - Math.PI / 2;
                const angleDeg = angle * 180 / Math.PI;
                return angleDeg > 90 || angleDeg < -90 ? "end" : "start";
            })
            .style("cursor", "pointer")
            .text(d => d.trend)
            .on("click", (event, d) => {
                window.location.href = `/drivers.html?trend=${encodeURIComponent(d.trend)}`;
            });

        svg.append("text")
            .attr("x", chartElement.clientWidth - 150)
            .attr("y", chartElement.clientHeight - 200)
            .text("POTENTIAL IMPACT")
            .style("font-size", "14px")
            .style("font-weight", "bold")
            .style("fill", "#333");

        const legendData = [
            { label: "0â€“1", color: "#d73027" },
            { label: "1â€“2", color: "#fc8d59" },
            { label: "2â€“3", color: "#fee08b" },
            { label: "3â€“4", color: "#91cf60" },
            { label: "4â€“5", color: "#1a9850" },
        ];

        const legend = svg.append("g")
            .attr("transform", `translate(${chartElement.clientWidth - 150}, ${chartElement.clientHeight - 180})`);

        legend.selectAll("rect")
            .data(legendData)
            .enter()
            .append("rect")
            .attr("x", 0)
            .attr("y", (d, i) => i * 25)
            .attr("width", 20)
            .attr("height", 20)
            .attr("fill", d => d.color);

        legend.selectAll("text")
            .data(legendData)
            .enter()
            .append("text")
            .attr("x", 30)
            .attr("y", (d, i) => i * 25 + 15)
            .text(d => d.label)
            .style("font-size", "14px");

        container.append("line")
            .attr("x1", -radius)
            .attr("y1", 0)
            .attr("x2", radius)
            .attr("y2", 0)
            .style("stroke", "#888")
            .style("stroke-dasharray", "4,2");

        container.append("text")
            .attr("x", 0)
            .attr("y", -10)
            .attr("text-anchor", "middle")
            .style("fill", "#666")
            .style("font-size", "14px")
            .style("font-weight", "bold")
            .text("POTENTIAL IMPACT");
    }

    async function initialize() {
        const data = await fetchChartData();
        await renderRadar(data);
    }

    window.addEventListener("resize", initialize);
    initialize();
</script>

</body>
</html>
